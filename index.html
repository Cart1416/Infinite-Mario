<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mario Infinite</title>
    <style>
        @font-face {
            font-family: '8bit';
            src: url('http://ahf2139.pythonanywhere.com/images/marioimages/8bit.ttf');
        }

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div id="center">
        <canvas id="canvas" width="1280" height="720" style="border: none; margin: none;"></canvas>
    </div>
    <script src=" https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js "></script>
    <script src="https://ahf2139.pythonanywhere.com/cartGameLibrary.js"></script>
    <script>
        cGL.initialize("canvas");
        canvas.width = window.innerWidth - 10;
        canvas.height = window.innerHeight - 15;

        const assetsDirectory = "http://ahf2139.pythonanywhere.com/images/marioimages";
        const marioRightImgs = [
            `${assetsDirectory}/Mario_Small.png`,
            `${assetsDirectory}/Mario_Small_Walk_0.png`,
            `${assetsDirectory}/Mario_Small_Walk_1.png`,
            `${assetsDirectory}/Mario_Small_Walk_2.png`,
            `${assetsDirectory}/Mario_Small_Jumping.png`
        ];
        const marioLeftImgs = [
            `${assetsDirectory}/Mario_Small_Left.png`,
            `${assetsDirectory}/Mario_Small_Left_Walk_0.png`,
            `${assetsDirectory}/Mario_Small_Left_Walk_1.png`,
            `${assetsDirectory}/Mario_Small_Left_Walk_2.png`,
            `${assetsDirectory}/Mario_Small_Left_Jumping.png`
        ];
        const marioBigRightImgs = [
            `${assetsDirectory}/Mario_Big.png`,
            `${assetsDirectory}/Mario_Big_Walk_0.png`,
            `${assetsDirectory}/Mario_Big_Walk_1.png`,
            `${assetsDirectory}/Mario_Big_Walk_2.png`,
            `${assetsDirectory}/Mario_Big_Jumping.png`
        ];
        const marioBigLeftImgs = [
            `${assetsDirectory}/Mario_Big_Left.png`,
            `${assetsDirectory}/Mario_Big_Left_Walk_0.png`,
            `${assetsDirectory}/Mario_Big_Left_Walk_1.png`,
            `${assetsDirectory}/Mario_Big_Left_Walk_2.png`,
            `${assetsDirectory}/Mario_Big_Left_Jumping.png`
        ];
        var renderingState = 0;
        cGL.loadImage("title", `${assetsDirectory}/Title.png`);

        marioRightImgs.forEach((img, index) => cGL.loadImage(`marioRight${index}`, img));
        marioLeftImgs.forEach((img, index) => cGL.loadImage(`marioLeft${index}`, img));
        marioBigRightImgs.forEach((img, index) => cGL.loadImage(`marioBigRight${index}`, img));
        marioBigLeftImgs.forEach((img, index) => cGL.loadImage(`marioBigLeft${index}`, img));
        blockTypes = 10;
        cGL.loadImage("Goomba", `${assetsDirectory}/entities/Goomba.png`);
        cGL.loadImage("Goomba1", `${assetsDirectory}/entities/Goomba1.png`);

        // Define your level map
        var levelMap = [
            [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
            [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
            [1, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
            [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
            [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
            [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
            [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 1],
            [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 2, 0, 0, 9, 9, 9, 0, 2, 0, 0, 0, 0, 0, 1],
            [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 1],
            [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 2, 3, 4, 5, 6, 7, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
            [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
            [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 9, 9, 9, 9, 9, 9, 9, 9, 0, 0, 1],
            [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]
        ];
        var backgroundMusic = "ground_music.mp3";
        var backgroundColor = "#9494ff";
        var spawnPoint = {x: 64, y: 64 * 3}

        var gamePadAvailable = false;
        window.addEventListener("gamepadconnected", (e) => {
            gamePadAvailable = true;
        });
        window.addEventListener("gamepaddisconnected", (e) => {
            gamePadAvailable = false;
        });
        const userAgent = navigator.userAgent;

        // Load block textures
        const blockTextures = [];
        for (let i = 0; i < blockTypes; i++) {
            cGL.loadImage(`block${i}`, `${assetsDirectory}/blocks/${i}.png`);
        }

        var camera = {
            x: 0,
            y: 0,
            width: canvas.width,
            height: canvas.height
        };

        var cameraBounds = {
            left: 200,   // When Mario's x is less than this, move the camera left
            right: 600,  // When Mario's x is greater than this, move the camera right
            top: 150,    // When Mario's y is less than this, move the camera up
            bottom: 450  // When Mario's y is greater than this, move the camera down
        };

        var mario = {
            x: 64,
            y: 64 * 3,
            width: 32 * 2,
            height: 64 * 2,
            speed: 5,
            direction: 'right',
            frame: 0,
            frameCount: 4,
            animationSpeed: 10,
            frameTimer: 0,
            jumping: false,
            jumpSpeed: 0,
            jumpTimer: 0,
            gravity: 1,
            groundLevel: canvas.height - 128,
            powerUp: 0,
            prevX: 0,
            prevY: 0
        };
        mario.x = spawnPoint.x;
        mario.y = spawnPoint.y;
        var coinsCollected = 0;

        var entities = [];

        function addGoomba(x, y) {
            var goombaTemplate = {
                id: 1,
                x: x,
                y: y,
                width: mario.width,
                height: mario.width,
                speed: 2,
                frame: 0,
                frameCount: 1,
                animationSpeed: 30,
                frameTimer: 0,
                gravity: 5,
                direction: 'left',
                update: function() {
                    let prevX = this.x;
                    let prevY = this.y;
                    if (this.direction == 'left') {
                        this.x -= this.speed;
                    }
                    if (this.direction == 'right') {
                        this.x += this.speed;
                    }
                    this.frameTimer++;
                    if (this.frameTimer >= this.animationSpeed) {
                        if (this.frame >= this.frameCount) {
                            this.frame = 0;
                        } else {
                            ++this.frame;
                        }
                        this.frameTimer = 0;
                    }
                    this.y += this.gravity;
                    const blockSize = this.width;
                    const hitboxHeight = this.height;
                    const hitboxOffset = this.height - 64;
                    const marioTop = this.y + hitboxOffset;
                    const marioBottom = this.y + hitboxOffset + hitboxHeight;
                    const marioLeft = this.x;
                    const marioRight = this.x + this.width;
                    const prevBottom = prevY + hitboxOffset + hitboxHeight;
                    const prevTop = prevY + hitboxOffset;
                    const prevLeft = prevX;
                    const prevRight = prevX + this.width;
                    for (let y = 0; y < levelMap.length; y++) {
                        for (let x = 0; x < levelMap[y].length; x++) {
                            const blockType = levelMap[y][x];
                            if ((blockType != 0) && (blockType != 4) && (blockType != 7) && (blockType != 9)) {
                                const blockX = x * blockSize;
                                const blockY = y * blockSize;
                                const blockTop = blockY;
                                const blockBottom = blockY + blockSize;
                                const blockLeft = blockX;
                                const blockRight = blockX + blockSize;

                                if (marioRight > blockLeft && marioLeft < blockRight && marioBottom > blockTop && marioTop < blockBottom) {
                                    // Collision from top
                                    if (prevBottom <= blockTop && marioBottom > blockTop) {
                                        this.y = blockTop - hitboxHeight - hitboxOffset;
                                    }
                                    // Collision from bottom
                                    else if (prevTop >= blockBottom && marioTop < blockBottom) {
                                        this.y = blockBottom - hitboxOffset;
                                    }
                                    // Collision from left
                                    else if (prevRight <= blockLeft && marioRight > blockLeft) {
                                        this.x = blockLeft - this.width;
                                        this.direction = 'left';
                                    }
                                    // Collision from right
                                    else if (prevLeft >= blockRight && marioLeft < blockRight) {
                                        this.x = blockRight;
                                        this.direction = 'right';
                                    }
                                }
                            }
                        }
                    }
                    const blockX = mario.x;
                    const blockY = mario.y;
                    const blockTop = blockY;
                    const blockBottom = blockY + mario.height;
                    const blockLeft = blockX;
                    const blockRight = blockX + mario.width;

                    if (marioRight > blockLeft && marioLeft < blockRight && marioBottom > blockTop && marioTop < blockBottom) {
                        // Collision from top
                        if (prevBottom <= blockTop && marioBottom > blockTop) {
                            mario.x = spawnPoint.x;
                            mario.y = spawnPoint.y;
                            alert("insert death screen here");
                        }
                        // Collision from bottom
                        // mario collides with our top stomping us
                        else if (prevTop >= blockBottom && marioTop < blockBottom) {
                            entities.splice(i, 1);
                            cGL.playSound(`${assetsDirectory}/sounds/stomp.mp3`);
                            mario.jumping = true;
                            mario.jumpSpeed = -15;
                        }
                        // Collision from left
                        else if (prevRight <= blockLeft && marioRight > blockLeft) {
                            mario.x = spawnPoint.x;
                            mario.y = spawnPoint.y;
                            alert("insert death screen here");
                        }
                        // Collision from right
                        else if (prevLeft >= blockRight && marioLeft < blockRight) {
                            mario.x = spawnPoint.x;
                            mario.y = spawnPoint.y;
                            alert("insert death screen here");
                        }
                    }
                },
                render: function() {
                    if (this.frame == 0) {
                        cGL.drawImage("Goomba", this.x + camera.x, this.y + camera.y, this.width, this.height);
                    } else if (this.frame == 1) {
                        cGL.drawImage("Goomba1", this.x + camera.x, this.y + camera.y, this.width, this.height);
                    }
                }
            };
            entities.push(goombaTemplate);
        }

        function game() {
            for (let i = 0; i < entities.length; i++) {
                entities[i].update();
            }
            let prevX = mario.x;
            let prevY = mario.y;
            mario.prevX = prevX;
            mario.prevY = prevY;
            const gamePads = navigator.getGamepads();
            if (gamePadAvailable) {
                if (userAgent.indexOf("Chrome") > -1 || userAgent.indexOf("Chromium") > -1) {
                    for (let i = 0; i < gamePads.length; i++) {
                        if (gamePads[i].buttons[14]) { // Left arrow
                            mario.x -= mario.speed;
                            mario.direction = 'left';
                            mario.frameTimer++;
                            if (mario.frameTimer >= mario.animationSpeed) {
                                mario.frame = (mario.frame + 1) % (mario.frameCount - 1); // 3 walking frames
                                mario.frameTimer = 0;
                            }
                        } else if (gamePads[i].buttons[15]) { // Right arrow
                            mario.x += mario.speed;
                            mario.direction = 'right';
                            mario.frameTimer++;
                            if (mario.frameTimer >= mario.animationSpeed) {
                                mario.frame = (mario.frame + 1) % (mario.frameCount - 1); // 3 walking frames
                                mario.frameTimer = 0;
                            }
                        } else {
                            mario.frame = 0;
                        }
                    }
                } else if (userAgent.indexOf("Firefox") > -1) {
                    for (let i = 0; i < gamePads.length; i++) {
                        if (gamePads[i].buttons[15]) { // Left arrow
                            mario.x -= mario.speed;
                            mario.direction = 'left';
                            mario.frameTimer++;
                            if (mario.frameTimer >= mario.animationSpeed) {
                                mario.frame = (mario.frame + 1) % (mario.frameCount - 1); // 3 walking frames
                                mario.frameTimer = 0;
                            }
                        } else if (gamePads[i].buttons[16]) { // Right arrow
                            mario.x += mario.speed;
                            mario.direction = 'right';
                            mario.frameTimer++;
                            if (mario.frameTimer >= mario.animationSpeed) {
                                mario.frame = (mario.frame + 1) % (mario.frameCount - 1); // 3 walking frames
                                mario.frameTimer = 0;
                            }
                        } else {
                            mario.frame = 0;
                        }
                    }
                }
            }

            if (cGL.keysDown[37]) { // Left arrow
                mario.x -= mario.speed;
                mario.direction = 'left';
                mario.frameTimer++;
                if (mario.frameTimer >= mario.animationSpeed) {
                    mario.frame = (mario.frame + 1) % (mario.frameCount - 1); // 3 walking frames
                    mario.frameTimer = 0;
                }
            } else if (cGL.keysDown[39]) { // Right arrow
                mario.x += mario.speed;
                mario.direction = 'right';
                mario.frameTimer++;
                if (mario.frameTimer >= mario.animationSpeed) {
                    mario.frame = (mario.frame + 1) % (mario.frameCount - 1); // 3 walking frames
                    mario.frameTimer = 0;
                }
            } else {
                mario.frame = 0;
            }

            if ((cGL.keysDown[38] || cGL.keysDown[32])) { // Up arrow or space bar
                if (!mario.jumping) {
                    mario.jumping = true;
                    mario.jumpSpeed = -15;
                }
                ++mario.jumpTimer;
            } else {
                mario.jumpTimer = 0;
            }

            if ((cGL.keysDown[38] || cGL.keysDown[32]) && mario.jumpTimer == 8) { // Up arrow or space bar
                mario.jumping = true;
                mario.jumpSpeed = -15;
                ++mario.jumpTimer;
            }

            if (mario.jumpTimer == 1) {
                cGL.playSound(`${assetsDirectory}/sounds/jump.mp3`);
            }

            mario.y += mario.jumpSpeed;
            mario.jumpSpeed += mario.gravity;

            // Check for collisions
            handleCollisions(prevX, prevY);

            //camera controls
            if (cGL.keysDown[73]) { // I
                camera.y += 5;
            } else if (cGL.keysDown[74]) { // J
                camera.x += 5;
            } else if (cGL.keysDown[75]) { // K
                camera.y -= 5;
            } else if (cGL.keysDown[76]) { // L
                camera.x -= 5;
            }

            const cameraPaddingX = 200; // Horizontal padding from the screen edge
            const cameraPaddingY = 150; // Vertical padding from the screen edge

            // Horizontal camera movement
            if (mario.x + camera.x < cameraPaddingX) {
                camera.x += cameraPaddingX - (mario.x + camera.x);
            } else if (mario.x + mario.width + camera.x > camera.width - cameraPaddingX) {
                camera.x -= (mario.x + mario.width + camera.x) - (camera.width - cameraPaddingX);
            }

            // Vertical camera movement
            if (mario.y + camera.y < cameraPaddingY) {
                camera.y += cameraPaddingY - (mario.y + camera.y);
            } else if (mario.y + mario.height + camera.y > camera.height - cameraPaddingY) {
                camera.y -= (mario.y + mario.height + camera.y) - (camera.height - cameraPaddingY);
            }

            // Prevent the camera from going out of the level bounds
            const levelWidth = levelMap[0].length * mario.width;
            const levelHeight = levelMap.length * mario.height;

            camera.x = Math.min(0, Math.max(camera.x, camera.width - levelWidth));
            camera.y = Math.min(0, Math.max(camera.y, camera.height - levelHeight));

        }

        function handleCollisions(prevX, prevY) {
            const blockSize = mario.width;
            const hitboxHeight = mario.powerUp === 0 ? mario.height / 2 : mario.height;
            const hitboxOffset = mario.powerUp === 0 ? mario.height / 2 : 0;
            const marioTop = mario.y + hitboxOffset;
            const marioBottom = mario.y + hitboxOffset + hitboxHeight;
            const marioLeft = mario.x;
            const marioRight = mario.x + mario.width;
            const prevBottom = prevY + hitboxOffset + hitboxHeight;
            const prevTop = prevY + hitboxOffset;
            const prevLeft = prevX;
            const prevRight = prevX + mario.width;

            for (let y = 0; y < levelMap.length; y++) {
                for (let x = 0; x < levelMap[y].length; x++) {
                    const blockType = levelMap[y][x];
                    if (blockType == 1) { //ground
                        const blockX = x * blockSize;
                        const blockY = y * blockSize;
                        const blockTop = blockY;
                        const blockBottom = blockY + blockSize;
                        const blockLeft = blockX;
                        const blockRight = blockX + blockSize;

                        if (marioRight > blockLeft && marioLeft < blockRight && marioBottom > blockTop && marioTop < blockBottom) {
                            // Collision from top
                            if (prevBottom <= blockTop && marioBottom > blockTop) {
                                mario.y = blockTop - hitboxHeight - hitboxOffset;
                                mario.jumping = false;
                                mario.jumpSpeed = 0;
                            }
                            // Collision from bottom
                            else if (prevTop >= blockBottom && marioTop < blockBottom) {
                                mario.y = blockBottom - hitboxOffset;
                                mario.jumpSpeed = 0;
                            }
                            // Collision from left
                            else if (prevRight <= blockLeft && marioRight > blockLeft) {
                                mario.x = blockLeft - mario.width;
                            }
                            // Collision from right
                            else if (prevLeft >= blockRight && marioLeft < blockRight) {
                                mario.x = blockRight;
                            }
                        }
                    }
                    if (blockType == 2) { //brick
                        const blockX = x * blockSize;
                        const blockY = y * blockSize;
                        const blockTop = blockY;
                        const blockBottom = blockY + blockSize;
                        const blockLeft = blockX;
                        const blockRight = blockX + blockSize;

                        if (marioRight > blockLeft && marioLeft < blockRight && marioBottom > blockTop && marioTop < blockBottom) {
                            // Collision from top
                            if (prevBottom <= blockTop && marioBottom > blockTop) {
                                mario.y = blockTop - hitboxHeight - hitboxOffset;
                                mario.jumping = false;
                                mario.jumpSpeed = 0;
                            }
                            // Collision from bottom
                            else if (prevTop >= blockBottom && marioTop < blockBottom) {
                                mario.y = blockBottom - hitboxOffset;
                                mario.jumpSpeed = 0;
                                if (mario.powerUp > 0) {
                                    levelMap[y][x] = 0;
                                    cGL.playSound(`${assetsDirectory}/sounds/brick_break.mp3`);
                                }
                            }
                            // Collision from left
                            else if (prevRight <= blockLeft && marioRight > blockLeft) {
                                mario.x = blockLeft - mario.width;
                            }
                            // Collision from right
                            else if (prevLeft >= blockRight && marioLeft < blockRight) {
                                mario.x = blockRight;
                            }
                        }
                    }
                    if (blockType == 3) { //question block
                        const blockX = x * blockSize;
                        const blockY = y * blockSize;
                        const blockTop = blockY;
                        const blockBottom = blockY + blockSize;
                        const blockLeft = blockX;
                        const blockRight = blockX + blockSize;

                        if (marioRight > blockLeft && marioLeft < blockRight && marioBottom > blockTop && marioTop < blockBottom) {
                            // Collision from top
                            if (prevBottom <= blockTop && marioBottom > blockTop) {
                                mario.y = blockTop - hitboxHeight - hitboxOffset;
                                mario.jumping = false;
                                mario.jumpSpeed = 0;
                            }
                            // Collision from bottom
                            else if (prevTop >= blockBottom && marioTop < blockBottom) {
                                mario.y = blockBottom - hitboxOffset;
                                mario.jumpSpeed = 0;
                            }
                            // Collision from left
                            else if (prevRight <= blockLeft && marioRight > blockLeft) {
                                mario.x = blockLeft - mario.width;
                            }
                            // Collision from right
                            else if (prevLeft >= blockRight && marioLeft < blockRight) {
                                mario.x = blockRight;
                            }
                        }
                    }
                    if (blockType == 4) { //coin
                        const blockX = x * blockSize;
                        const blockY = y * blockSize;
                        const blockTop = blockY;
                        const blockBottom = blockY + blockSize;
                        const blockLeft = blockX;
                        const blockRight = blockX + blockSize;

                        if (marioRight > blockLeft && marioLeft < blockRight && marioBottom > blockTop && marioTop < blockBottom) {
                            // Collision from top
                            if (prevBottom <= blockTop && marioBottom > blockTop) {
                                levelMap[y][x] = 0;
                                ++coinsCollected;
                                cGL.playSound(`${assetsDirectory}/sounds/coin.mp3`);
                            }
                            // Collision from bottom
                            else if (prevTop >= blockBottom && marioTop < blockBottom) {
                                levelMap[y][x] = 0;
                                ++coinsCollected;
                                cGL.playSound(`${assetsDirectory}/sounds/coin.mp3`);
                            }
                            // Collision from left
                            else if (prevRight <= blockLeft && marioRight > blockLeft) {
                                levelMap[y][x] = 0;
                                ++coinsCollected;
                                cGL.playSound(`${assetsDirectory}/sounds/coin.mp3`);
                            }
                            // Collision from right
                            else if (prevLeft >= blockRight && marioLeft < blockRight) {
                                levelMap[y][x] = 0;
                                ++coinsCollected;
                                cGL.playSound(`${assetsDirectory}/sounds/coin.mp3`);
                            }
                        }
                    }
                    if (blockType == 5) { //question block with a coin
                        const blockX = x * blockSize;
                        const blockY = y * blockSize;
                        const blockTop = blockY;
                        const blockBottom = blockY + blockSize;
                        const blockLeft = blockX;
                        const blockRight = blockX + blockSize;

                        if (marioRight > blockLeft && marioLeft < blockRight && marioBottom > blockTop && marioTop < blockBottom) {
                            // Collision from top
                            if (prevBottom <= blockTop && marioBottom > blockTop) {
                                mario.y = blockTop - hitboxHeight - hitboxOffset;
                                mario.jumping = false;
                                mario.jumpSpeed = 0;
                            }
                            // Collision from bottom
                            else if (prevTop >= blockBottom && marioTop < blockBottom) {
                                mario.y = blockBottom - hitboxOffset;
                                mario.jumpSpeed = 0;
                                levelMap[y][x] = 3;
                                ++coinsCollected;
                                cGL.playSound(`${assetsDirectory}/sounds/coin.mp3`);
                            }
                            // Collision from left
                            else if (prevRight <= blockLeft && marioRight > blockLeft) {
                                mario.x = blockLeft - mario.width;
                            }
                            // Collision from right
                            else if (prevLeft >= blockRight && marioLeft < blockRight) {
                                mario.x = blockRight;
                            }
                        }
                    }
                    if (blockType == 6) { //question block with a mushroom
                        const blockX = x * blockSize;
                        const blockY = y * blockSize;
                        const blockTop = blockY;
                        const blockBottom = blockY + blockSize;
                        const blockLeft = blockX;
                        const blockRight = blockX + blockSize;

                        if (marioRight > blockLeft && marioLeft < blockRight && marioBottom > blockTop && marioTop < blockBottom) {
                            // Collision from top
                            if (prevBottom <= blockTop && marioBottom > blockTop) {
                                mario.y = blockTop - hitboxHeight - hitboxOffset;
                                mario.jumping = false;
                                mario.jumpSpeed = 0;
                            }
                            // Collision from bottom
                            else if (prevTop >= blockBottom && marioTop < blockBottom) {
                                mario.y = blockBottom - hitboxOffset;
                                mario.jumpSpeed = 0;
                                levelMap[y][x] = 3;
                                above = y - 1;
                                levelMap[above][x] = 7;
                                cGL.playSound(`${assetsDirectory}/sounds/powerUpAppear.mp3`);
                            }
                            // Collision from left
                            else if (prevRight <= blockLeft && marioRight > blockLeft) {
                                mario.x = blockLeft - mario.width;
                            }
                            // Collision from right
                            else if (prevLeft >= blockRight && marioLeft < blockRight) {
                                mario.x = blockRight;
                            }
                        }
                    }
                    if (blockType == 7) { //non moving mushroom
                        const blockX = x * blockSize;
                        const blockY = y * blockSize;
                        const blockTop = blockY;
                        const blockBottom = blockY + blockSize;
                        const blockLeft = blockX;
                        const blockRight = blockX + blockSize;

                        if (marioRight > blockLeft && marioLeft < blockRight && marioBottom > blockTop && marioTop < blockBottom) {
                            // Collision from top
                            if (prevBottom <= blockTop && marioBottom > blockTop) {
                                levelMap[y][x] = 0;
                                mario.powerUp = 1;
                                cGL.playSound(`${assetsDirectory}/sounds/mushroom.mp3`);
                            }
                            // Collision from bottom
                            else if (prevTop >= blockBottom && marioTop < blockBottom) {
                                levelMap[y][x] = 0;
                                mario.powerUp = 1;
                                cGL.playSound(`${assetsDirectory}/sounds/mushroom.mp3`);
                            }
                            // Collision from left
                            else if (prevRight <= blockLeft && marioRight > blockLeft) {
                                levelMap[y][x] = 0;
                                mario.powerUp = 1;
                                cGL.playSound(`${assetsDirectory}/sounds/mushroom.mp3`);
                            }
                            // Collision from right
                            else if (prevLeft >= blockRight && marioLeft < blockRight) {
                                levelMap[y][x] = 0;
                                mario.powerUp = 1;
                                cGL.playSound(`${assetsDirectory}/sounds/mushroom.mp3`);
                            }
                        }
                    }
                    if (blockType == 8) { //question block with infinite coins
                        const blockX = x * blockSize;
                        const blockY = y * blockSize;
                        const blockTop = blockY;
                        const blockBottom = blockY + blockSize;
                        const blockLeft = blockX;
                        const blockRight = blockX + blockSize;

                        if (marioRight > blockLeft && marioLeft < blockRight && marioBottom > blockTop && marioTop < blockBottom) {
                            // Collision from top
                            if (prevBottom <= blockTop && marioBottom > blockTop) {
                                mario.y = blockTop - hitboxHeight - hitboxOffset;
                                mario.jumping = false;
                                mario.jumpSpeed = 0;
                            }
                            // Collision from bottom
                            else if (prevTop >= blockBottom && marioTop < blockBottom) {
                                mario.y = blockBottom - hitboxOffset;
                                mario.jumpSpeed = 0;
                                ++coinsCollected;
                                cGL.playSound(`${assetsDirectory}/sounds/coin.mp3`);
                            }
                            // Collision from left
                            else if (prevRight <= blockLeft && marioRight > blockLeft) {
                                mario.x = blockLeft - mario.width;
                            }
                            // Collision from right
                            else if (prevLeft >= blockRight && marioLeft < blockRight) {
                                mario.x = blockRight;
                            }
                        }
                    }
                    if (blockType == 9) { //goomba spawn point
                        const blockX = x * blockSize;
                        const blockY = y * blockSize;
                        const blockTop = blockY;
                        const blockBottom = blockY + blockSize;
                        const blockLeft = blockX;
                        const blockRight = blockX + blockSize;

                        levelMap[y][x] = 0;
                        addGoomba(x * blockSize, y * blockSize);
                    }
                }
            }

            for (let i = 0; i < entities.length; i++) {
                const entityType = entities[i].id;
                if (entityType == 1) { //goomba
                    const blockX = entities[i].x;
                    const blockY = entities[i].y;
                    const blockTop = blockY;
                    const blockBottom = blockY + entities[i].height;
                    const blockLeft = blockX;
                    const blockRight = blockX + entities[i].width;

                    if (marioRight > blockLeft && marioLeft < blockRight && marioBottom > blockTop && marioTop < blockBottom) {
                        // Collision from top
                        if (prevBottom <= blockTop && marioBottom > blockTop) {
                            entities.splice(i, 1);
                            cGL.playSound(`${assetsDirectory}/sounds/stomp.mp3`);
                            mario.jumping = true;
                            mario.jumpSpeed = -15;
                        }
                        // Collision from bottom
                        else if (prevTop >= blockBottom && marioTop < blockBottom) {
                            mario.x = spawnPoint.x;
                            mario.y = spawnPoint.y;
                            alert("insert death screen here");
                        }
                        // Collision from left
                        else if (prevRight <= blockLeft && marioRight > blockLeft) {
                            mario.x = spawnPoint.x;
                            mario.y = spawnPoint.y;
                            alert("insert death screen here");
                        }
                        // Collision from right
                        else if (prevLeft >= blockRight && marioLeft < blockRight) {
                            mario.x = spawnPoint.x;
                            mario.y = spawnPoint.y;
                            alert("insert death screen here");
                        }
                    }
                }
            }

            // Update ground level based on collisions
            if (!mario.jumping) {
                mario.groundLevel = canvas.height - 128;
                for (let y = 0; y < levelMap.length; y++) {
                    for (let x = 0; x < levelMap[y].length; x++) {
                        const blockType = levelMap[y][x];
                        if (blockType !== 0) {
                            const blockX = x * blockSize;
                            const blockY = y * blockSize;
                            const blockTop = blockY;
                            const blockBottom = blockY + blockSize;
                            const blockLeft = blockX;
                            const blockRight = blockX + blockSize;

                            if (marioRight > blockLeft && marioLeft < blockRight && marioBottom >= blockTop && marioTop < blockBottom) {
                                mario.groundLevel = blockTop - hitboxHeight - hitboxOffset;
                            }
                        }
                    }
                }
            }
        }

        function renderBlocks() {
            const blockSize = mario.width;
            for (let y = 0; y < levelMap.length; y++) {
                for (let x = 0; x < levelMap[y].length; x++) {
                    const blockType = levelMap[y][x];
                    if (blockType !== 0) {
                        const blockTexture = blockTextures[blockType];
                        const xPos = (x * blockSize) + camera.x;
                        const yPos = (y * blockSize) + camera.y;
                        cGL.drawImage(`block${blockType}`, xPos, yPos, blockSize, blockSize);
                    }
                }
            }
        }

        function renderMario() {
            let marioImageId;
            if (mario.powerUp == 0) {
                if (mario.jumping) {
                    marioImageId = mario.direction === 'right' ? 'marioRight4' : 'marioLeft4';
                } else {
                    marioImageId = mario.direction === 'right' ? `marioRight${mario.frame}` : `marioLeft${mario.frame}`;
                }
            } else if (mario.powerUp == 1) {
                if (mario.jumping) {
                    marioImageId = mario.direction === 'right' ? 'marioBigRight4' : 'marioBigLeft4';
                } else {
                    marioImageId = mario.direction === 'right' ? `marioBigRight${mario.frame}` : `marioBigLeft${mario.frame}`;
                }
            }
            cGL.drawImage(marioImageId, mario.x + camera.x, mario.y + camera.y, mario.width, mario.height);
        }

        function renderEntities() {
            for (let i = 0; i < entities.length; i++) {
                entities[i].render();
            }
        }

        function renderCoinCounter() {
            const text = `Coins: ${coinsCollected}`;
            const x = canvas.width / 2;
            const y = 30;
            cGL.drawText(text, x, y, "24px '8bit'", "black", "center", "top");
        }

        cGL.addButton("playButton", (canvas.width / 2) - (100 /2), canvas.height / 4 * 3, 100, 40, true, "Play!")

        function renderTitle() {
            cGL.drawImage("title", (canvas.width / 2) - (352 / 2), canvas.height / 4, 352, 286);
        }

        function checkPlayButton() {
            if (cGL.buttons.playButton.pressed) {
                renderingState = 2; // we will set this to 1 for level select later
                cGL.removeButton("playButton")
                cGL.startBackgroundMusic(`${assetsDirectory}/sounds/` + backgroundMusic);
            }
        }

        function render() {
            cGL.clear();
            if (renderingState == 2) {
                cGL.drawBackground(backgroundColor);
                renderBlocks();
                renderEntities();
                renderMario();
                renderCoinCounter();
            } else if (renderingState == 0) {
                cGL.drawBackground("#9494ff");
                renderTitle();
                checkPlayButton();
            }
        }

        function loop(timestamp) {
            var elapsed = timestamp - lastTime;
            if (elapsed > frameInterval) {
                if (renderingState == 2) {
                    game();
                }
                render();
                cGL.renderButtons();
                cGL.loop();
                lastTime = timestamp - (elapsed % frameInterval);
            }
            requestAnimationFrame(loop);
        }

        var lastTime = 0;
        var frameInterval = 1000 / 60;
        ctx.imageSmoothingEnabled = false;
        requestAnimationFrame(loop);
    </script>
</body>
</html>
